/*!
 * task-manager-lhy 0.1.1 (https://github.com/BUPTlhuanyu/task-manager)
 * API https://github.com/BUPTlhuanyu/task-manager/blob/master/doc/api.md
 * Copyright 2017-2020 BUPTlhuanyu. All Rights Reserved
 * Licensed under MIT (https://github.com/BUPTlhuanyu/task-manager/blob/master/LICENSE)
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).TaskManager=e()}(this,(function(){"use strict";return class{constructor(t,e=2e4){this.threshold=t,this.rest=t,this.readyToRun=[],this.result=[],this.timeout=e,this._afterTaskCompletedChanged=this._afterTaskCompletedChanged.bind(this),this.stopWaitingPromiseFromNow=this.stopWaitingPromiseFromNow.bind(this),this.wakeUp=this.wakeUp.bind(this),this._stopFromNow=!1}addTask({task:t,timeout:e}){return this.rest>0?new Promise(s=>{this.rest--,s(this._promiseWithTimeout(t,e))}).then(this._afterTaskCompletedChanged,this._afterTaskCompletedChanged):new Promise(s=>{this.readyToRun.push({task:t,resolve:s,timeout:e})})}stopWaitingPromiseFromNow(){return this._stopFromNow=!0,this.result}wakeUp(){return this.rest===this.threshold&&this._stopFromNow&&(this._stopFromNow=!1,this.rest--,this._runNextTask()),this.result}_afterTaskCompletedChanged(t){return this.result.push(t),setTimeout(this._runNextTask.bind(this),0),t}_promiseWithTimeout(t,e=this.timeout){let s,i=null;s="function"==typeof t?t():Promise.resolve(t);let o=new Promise(t=>{i=setTimeout(()=>{t("超时了")},e)});return Promise.race([s,o]).finally(()=>{clearTimeout(i),i=null})}_runNextTask(){if(this.rest++,!this._stopFromNow&&this.readyToRun.length>0){let t=this.readyToRun.shift();t&&(this.rest--,new Promise(e=>{let{task:s,resolve:i,timeout:o}=t;e(this._promiseWithTimeout(()=>{let t=s();return i(t),t},o))}).then(this._afterTaskCompletedChanged,this._afterTaskCompletedChanged))}}}}));
